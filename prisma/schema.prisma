generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// =========================================================
// ENUMS
// =========================================================
//
enum PayPeriodType {
  WEEKLY
  BIWEEKLY
  SEMIMONTHLY
  MONTHLY
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum PayrollPeriodStatus {
  OPEN
  LOCKED
  APPROVED
}

enum PtoTransactionType {
  ACCRUAL
  USAGE
  ADJUSTMENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

//
// =========================================================
// CORE MODELS
// =========================================================
//
model Organization {
  id       Int    @id @default(autoincrement())
  name     String
  timezone String @default("America/New_York")

  // ✅ Org contact (used by settings/services)
  phone String?

  // ✅ Organization Address (added to match your services)
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @default("USA")

  // ✅ Default (active) location
  defaultLocationId Int?      @unique
  defaultLocation   Location? @relation("OrgDefaultLocation", fields: [defaultLocationId], references: [id])

  // =========================================================
  // ORG-LEVEL PAYROLL SETTINGS (required by your code)
  // NOTE: Locations can still override these; org fields exist
  // so your org services/controllers compile + work.
  // =========================================================

  // --------------------
  // Pay Period Settings
  // --------------------
  payPeriodType      PayPeriodType @default(WEEKLY)
  weekStartDay       Int           @default(1) // 0=Sun .. 6=Sat
  biweeklyAnchorDate DateTime?
  cutoffTime         String?       @default("17:00") // "HH:mm"

  // --------------------
  // Auto Lunch Rules
  // --------------------
  autoLunchEnabled       Boolean @default(false)
  autoLunchMinutes       Int     @default(30)
  autoLunchMinimumShift  Float   @default(6.0)
  autoLunchDeductOnce    Boolean @default(true)
  autoLunchIgnoreIfBreak Boolean @default(false)

  // --------------------
  // Overtime Rules
  // --------------------
  overtimeDailyEnabled          Boolean @default(false)
  overtimeDailyThresholdHours   Float   @default(8.0)

  overtimeWeeklyEnabled         Boolean @default(true)
  overtimeWeeklyThresholdHours  Float   @default(40.0)

  doubleTimeEnabled             Boolean @default(false)
  doubletimeDailyThresholdHours Float   @default(12.0)

  // --------------------
  // PTO Rules
  // --------------------
  ptoEnabled           Boolean @default(false)
  accrualRatePerPeriod Float?
  maxPtoBalance        Float?
  carryoverEnabled     Boolean @default(false)
  carryoverLimit       Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ All locations for org
  locations       Location[]        @relation("OrgLocations")
  employees       Employee[]
  PayrollPeriod   PayrollPeriod[]
  PayrollSnapshot PayrollSnapshot[]
  Holiday         Holiday[]
  User            User[]
}

model Location {
  id             Int    @id @default(autoincrement())
  organizationId Int
  name           String
  timezone       String

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  industry String?

  payPeriodType      PayPeriodType @default(WEEKLY)
  weekStartDay       Int?          @default(1)
  biweeklyAnchorDate DateTime?

  semiMonthCut1 Int? @default(1)
  semiMonthCut2 Int? @default(16)
  monthlyCutDay Int? @default(1)

  cutoffTime String? @default("17:00")

  autoLunchEnabled       Boolean @default(false)
  autoLunchMinutes       Int     @default(30)
  autoLunchMinimumShift  Int     @default(6)
  autoLunchDeductOnce    Boolean @default(true)
  autoLunchIgnoreIfBreak Boolean @default(true)

  overtimeRule                  String  @default("DAILY")
  overtimeDailyEnabled          Boolean @default(true)
  overtimeDailyThresholdHours   Float   @default(8.0)
  doubletimeDailyEnabled        Boolean @default(false)
  doubletimeDailyThresholdHours Float   @default(12.0)
  overtimeWeeklyEnabled         Boolean @default(true)
  overtimeWeeklyThresholdHours  Float   @default(40.0)

  // ✅ Relations (EXPLICIT + MATCHING)
  organization           Organization  @relation("OrgLocations", fields: [organizationId], references: [id])
  defaultForOrganization Organization? @relation("OrgDefaultLocation")

  employees      Employee[]
  punches        Punch[]
  payrollPeriods PayrollPeriod[]
  devices        Device[]

  @@index([organizationId])
}

//
// =========================================================
// EMPLOYEE MODEL
// =========================================================
//
model Employee {
  id             Int @id @default(autoincrement())
  organizationId Int
  locationId     Int

  firstName     String
  middleName    String?
  lastName      String
  preferredName String?

  email String?
  pin   String  @unique

  status   EmployeeStatus @default(ACTIVE)
  photoUrl String?

  faceEmbedding String?
  faceId        String?
  faceEnabled   Boolean @default(false)

  phoneNumber String?
  phoneAlt    String?

  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @default("USA")

  jobTitle   String?
  department String?
  hireDate   DateTime? @default(now())

  dateOfBirth   DateTime?
  gender        Gender?
  ssnLast4      String?
  maritalStatus String?

  emergencyContacts EmergencyContact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isDeleted         Boolean   @default(false)
  terminatedAt      DateTime?
  terminationReason String?

  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location     @relation(fields: [locationId], references: [id])

  punches    Punch[]
  payRates   PayRate[]
  notes      EmployeeNote[]
  documents  EmployeeDocument[]
  activities EmployeeActivity[]

  ptoTransactions PtoTransaction[]
  ptoBalance      PtoBalance?
  ptoRequests     PtoRequest[]
}

//
// =========================================================
// REMAINDER OF MODELS (UNCHANGED)
// =========================================================
//
model EmergencyContact {
  id         Int      @id @default(autoincrement())
  employeeId Int
  name       String
  phone      String
  relation   String
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model Punch {
  id         Int      @id @default(autoincrement())
  employeeId Int
  locationId Int
  type       String
  timestamp  DateTime @default(now())

  isAutoLunch          Boolean @default(false)
  isSupervisorOverride Boolean @default(false)
  overrideByUserId     Int?
  overrideReason       String?

  employee Employee @relation(fields: [employeeId], references: [id])
  location Location @relation(fields: [locationId], references: [id])
}

model PayrollPeriod {
  id             Int  @id @default(autoincrement())
  organizationId Int
  locationId     Int?

  startDate DateTime
  endDate   DateTime
  status    PayrollPeriodStatus @default(OPEN)

  lockedAt       DateTime?
  lockedByUserId Int?

  approvedAt       DateTime?
  approvedByUserId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization    Organization      @relation(fields: [organizationId], references: [id])
  location        Location?         @relation(fields: [locationId], references: [id])
  PayrollSnapshot PayrollSnapshot[]

  @@unique([organizationId, locationId, startDate, endDate])
  @@index([organizationId, startDate, endDate])
}

model PayrollSnapshot {
  id             Int @id @default(autoincrement())
  organizationId Int
  payPeriodId    Int

  snapshotData   Json
  lockedAt       DateTime @default(now())
  lockedByUserId Int?

  createdAt DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id])
  payPeriod    PayrollPeriod @relation(fields: [payPeriodId], references: [id])

  @@unique([organizationId, payPeriodId])
  @@index([organizationId, payPeriodId])
}

model Holiday {
  id             Int @id @default(autoincrement())
  organizationId Int

  name  String
  date  DateTime
  paid  Boolean  @default(true)
  hours Float    @default(8)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, date])
  @@index([organizationId, date])
}

model PtoTransaction {
  id         Int @id @default(autoincrement())
  employeeId Int

  type   PtoTransactionType
  hours  Float
  reason String?

  createdAt DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model AuditLog {
  id Int @id @default(autoincrement())

  userId    Int?
  userEmail String?

  action     String
  entityType String?
  entityId   String?

  method    String?
  path      String?
  ipAddress String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
}

model User {
  id        Int    @id @default(autoincrement())
  email     String @unique
  password  String
  firstName String
  lastName  String
  role      String @default("ADMIN")

  tokenVersion Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  activitiesCreated EmployeeActivity[] @relation("EmployeeActivityCreatedBy")
}

model PayRate {
  id            Int      @id @default(autoincrement())
  employeeId    Int
  rate          Float
  effectiveDate DateTime
  createdAt     DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])
}

model EmployeeNote {
  id         Int      @id @default(autoincrement())
  employeeId Int
  note       String
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])
}

model DocumentType {
  id                   Int     @id @default(autoincrement())
  name                 String  @unique
  description          String?
  requiredForEmployees Boolean @default(false)

  documents EmployeeDocument[]
}

model EmployeeDocument {
  id         Int @id @default(autoincrement())
  employeeId Int

  fileName String
  fileUrl  String
  fileType String

  categoryId Int?
  createdAt  DateTime @default(now())

  expiresAt          DateTime?
  reminderDaysBefore Int?      @default(30)
  isExpired          Boolean   @default(false)

  employee Employee      @relation(fields: [employeeId], references: [id])
  category DocumentType? @relation(fields: [categoryId], references: [id])
}

model EmployeeActivity {
  id Int @id @default(autoincrement())

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId Int

  type        String
  description String
  metadata    Json?

  createdAt DateTime @default(now())

  createdBy   User? @relation("EmployeeActivityCreatedBy", fields: [createdById], references: [id])
  createdById Int?
}

model PtoBalance {
  id         Int   @id @default(autoincrement())
  employeeId Int   @unique
  balance    Float @default(0)

  employee Employee @relation(fields: [employeeId], references: [id])

  updatedAt DateTime @updatedAt
}

model PtoRequest {
  id         Int      @id @default(autoincrement())
  employeeId Int
  date       DateTime
  hours      Float

  status String @default("APPROVED")

  createdAt DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, date])
}

model Device {
  id         Int     @id @default(autoincrement())
  deviceId   String  @unique
  locationId Int
  name       String?

  isApproved Boolean @default(false)
  isActive   Boolean @default(true)

  lastSeenAt DateTime?
  createdAt  DateTime  @default(now())

  location Location @relation(fields: [locationId], references: [id])
}

model Industry {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departments Department[]
  jobTitles   JobTitle[]
}

model Department {
  id         Int      @id @default(autoincrement())
  industryId Int
  name       String
  sortOrder  Int?     @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  industry  Industry   @relation(fields: [industryId], references: [id])
  jobTitles JobTitle[]

  @@unique([industryId, name])
}

model JobTitle {
  id           Int      @id @default(autoincrement())
  industryId   Int
  departmentId Int?
  name         String
  sortOrder    Int?     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  industry   Industry    @relation(fields: [industryId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])

  @@unique([industryId, name, departmentId])
}
